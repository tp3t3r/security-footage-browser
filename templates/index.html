<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        let refreshInterval = null;
        
        // Check progress and update UI
        function checkProgress() {
            fetch('/progress')
                .then(r => r.json())
                .then(data => {
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    
                    if (data.done) {
                        progressBar.style.display = 'none';
                        if (!refreshInterval) {
                            refreshInterval = setInterval(() => location.reload(), 30000);
                        }
                    } else {
                        progressBar.style.display = 'block';
                        const percent = data.total_files > 0 
                            ? Math.round((data.files_done / data.total_files) * 100)
                            : 0;
                        progressBar.querySelector('.progress-fill').style.width = percent + '%';
                        progressText.textContent = `Building cache: Camera ${data.camera + 1}/${data.total_cameras}, File ${data.files_done}/${data.total_files} (${percent}%)`;
                        
                        // Check again in 5 seconds
                        setTimeout(checkProgress, 5000);
                    }
                });
        }
        
        // Start checking on load
        document.addEventListener('DOMContentLoaded', () => {
            checkProgress();
            
            // Stop auto-refresh when video is playing
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                video.addEventListener('play', () => {
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                });
                video.addEventListener('pause', () => {
                    if (!refreshInterval) {
                        refreshInterval = setInterval(() => location.reload(), 30000);
                    }
                });
            });
        });
    </script>
</head>
<body>
    <h1>{{ title }}</h1>
    
    <div id="progress-bar" class="progress-bar" style="display: none;">
        <div class="progress-fill"></div>
    </div>
    <p id="progress-text"></p>
    
    <div class="metadata">
        <p>Cache: {{ cache_size }} | <span id="last-update">Last update: just now</span></p>
        {% for cam in cameras %}
        <p>{{ cam.name }} - Last recording: {{ last_recordings.get(cam.id, 'N/A') }}</p>
        {% endfor %}
    </div>
    
    <div class="tabs">
        {% for cam in cameras %}
        <a href="/?camera={{ cam.id }}" class="tab {% if selected_camera == cam.id %}active{% endif %}">{{ cam.name }}</a>
        {% endfor %}
    </div>
    
    {% for file, segments in files %}
    <div class="day">
        <h2>{{ file }} ({{ segments|length }} segments)</h2>
        {% for seg in segments %}
        <div class="segment">
            <p>
                Segment {{ seg.segment }} ({{ seg.size }})
                <a href="/video?camera_id={{ seg.camera_id }}&file={{ seg.file }}&segment={{ seg.segment }}" download="{{ file }}_seg{{ seg.segment }}.mp4" class="download-btn">Download</a>
            </p>
            <video controls>
                <source src="/video?camera_id={{ seg.camera_id }}&file={{ seg.file }}&segment={{ seg.segment }}" type="video/mp4">
            </video>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</body>
</html>
